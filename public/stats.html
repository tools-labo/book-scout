<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BOOKスカウト｜ランキング</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="gheader" id="gheader">
    <div class="gheader-inner">
      <div class="gbrand">
        <a class="gbrand-title" href="./index.html">BOOKスカウト</a>
        <div class="gbrand-sub">ランキング</div>
      </div>

      <nav class="gnav" aria-label="グローバルナビ">
        <a href="./index.html">ホーム</a>
        <a href="./list.html">リスト</a>
        <a class="is-active" href="./stats.html">ランキング</a>
      </nav>
    </div>

    <div class="rank-genres" role="tablist" aria-label="ジャンル絞り込み" id="rankGenreTabs"></div>

    <div class="rank-tabs" role="tablist" aria-label="ランキング切り替え">
      <button class="rank-tab is-active" type="button" data-tab="views" role="tab" aria-selected="true">
        人気ランキング
      </button>
      <button class="rank-tab" type="button" data-tab="fav" role="tab" aria-selected="false">
        支持率ランキング
      </button>
    </div>
  </header>

  <main class="wrap">
    <div id="status" class="status"></div>

    <!-- 閲覧 -->
    <section class="section" id="panelViews" role="tabpanel" aria-label="人気ランキング" style="margin-top:10px;">
      <div class="section-head">
        <h2 class="section-title">人気ランキング</h2>
      </div>
      <p class="section-sub">※ 閲覧数＝作品詳細が表示された回数（同一セッションは1回）</p>
      <section id="rankViews" class="rank-grid"></section>
      <div class="rank-more"><button id="moreViews" type="button">もっと見る</button></div>
    </section>

    <!-- 支持率 -->
    <section class="section" id="panelFav" role="tabpanel" aria-label="支持率ランキング" style="margin-top:10px; display:none;">
      <div class="section-head">
        <h2 class="section-title">支持率ランキング</h2>
      </div>
      <p class="section-sub">※ 支持率＝（お気に入り数 ÷ この条件内のお気に入り総数）×100</p>
      <section id="rankFav" class="rank-grid"></section>
      <div class="rank-more"><button id="moreFav" type="button">もっと見る</button></div>
    </section>

    <footer class="gfooter" aria-label="サイトフッター">
      <div class="gfooter-inner">
        <span>© Tools-LABO</span>
        <a href="./privacy/">プライバシーポリシー</a>
        <a
          href="https://docs.google.com/forms/d/e/1FAIpQLSfF73yZ69HH-FASKEYSkp98zM92o4dtQLtiQs7BzLRuwsobfA/viewform?pli=1"
          target="_blank"
          rel="noopener noreferrer"
        >お問い合わせ</a>
      </div>
    </footer>
  </main>

  <script>
    function qs() { return new URLSearchParams(location.search); }

    async function loadJson(url, { bust = false } = {}) {
      const r = await fetch(url, { cache: bust ? "no-store" : "default" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function toText(v) {
      if (v == null) return "";
      if (typeof v === "string") return v.trim();
      if (typeof v === "number" || typeof v === "boolean") return String(v);

      if (Array.isArray(v)) {
        const xs = v.map(toText).filter(Boolean);
        const seen = new Set();
        const uniq = xs.filter(x => (seen.has(x) ? false : (seen.add(x), true)));
        return uniq.join(" / ");
      }

      if (typeof v === "object") {
        const keys = ["name","ja","jp","label","value","text","title","publisher","company","display","brand","manufacturer"];
        for (const k of keys) {
          if (v[k] != null) {
            const t = toText(v[k]);
            if (t) return t;
          }
        }
        return "";
      }
      return "";
    }

    function pick(it, keys) {
      for (const k of keys) {
        const v = k.includes(".")
          ? k.split(".").reduce((o, kk) => (o ? o[kk] : undefined), it)
          : it?.[k];
        if (Array.isArray(v)) return v;
        if (toText(v)) return v;
      }
      return null;
    }

    function pickArr(it, keys) {
      for (const k of keys) {
        const v = k.includes(".")
          ? k.split(".").reduce((o, kk) => (o ? o[kk] : undefined), it)
          : it?.[k];
        if (Array.isArray(v) && v.length) return v;
      }
      return [];
    }

    function normalizeImgUrl(u) {
      const raw = toText(u);
      if (!raw) return "";
      let x = "";
      try { x = encodeURI(raw); } catch { x = raw; }
      x = x.replaceAll("+", "%2B");
      return x;
    }

    function setStatus(msg) {
      const s = document.getElementById("status");
      if (s) s.textContent = msg;
    }

    function pillsMax6(list) {
      const xs = (list || []).map(toText).filter(Boolean);
      if (!xs.length) return "";
      const head = xs.slice(0, 6);
      const rest = xs.length - head.length;
      const more = rest > 0 ? `<span class="pill">+${rest}</span>` : "";
      return `<div class="pills">${head.map(x => `<span class="pill">${esc(x)}</span>`).join("")}${more}</div>`;
    }

    function pickRows(obj) {
      if (!obj) return [];
      if (Array.isArray(obj)) return obj;
      if (Array.isArray(obj?.rows)) return obj.rows;
      if (Array.isArray(obj?.data)) return obj.data;
      return [];
    }

    function getWorkMap(items) {
      const map = new Map();
      for (const it of (items || [])) {
        const seriesKey = toText(pick(it, ["seriesKey"]));
        if (!seriesKey) continue;
        map.set(seriesKey, it);
      }
      return map;
    }

    // ---- Rank item HTML（favは%表示） ----
    function posClass(rank){
      if (rank === 1) return "is-1";
      if (rank === 2) return "is-2";
      if (rank === 3) return "is-3";
      return "";
    }

    function fmtPct(x){
      if (!Number.isFinite(x)) return "0%";
      if (x >= 10) return `${Math.round(x)}%`;
      // 10%未満は1桁小数で視認性を上げる（0.0〜9.9）
      return `${Math.round(x * 10) / 10}%`;
    }

    function rankItemHtml({ rank, seriesKey, n, unit, work, favTotal }) {
      const key = encodeURIComponent(seriesKey);

      const title = toText(pick(work, ["title", "vol1.title"])) || seriesKey || "(無題)";
      const author = toText(pick(work, ["author", "vol1.author"])) || "";
      const magazine = toText(pick(work, ["magazine", "vol1.magazine"])) || "";

      const imgRaw = toText(pick(work, ["image", "vol1.image"])) || "";
      const img = normalizeImgUrl(imgRaw);

      const tagsJa = pickArr(work, ["tags", "vol1.tags"]).map(toText).filter(Boolean);

      const nNum = Number(n || 0);
      const isFav = unit === "fav";
      const rate = (isFav && favTotal > 0) ? (nNum / favTotal * 100) : 0;

      const numText = isFav ? fmtPct(rate) : String(nNum || 0);
      const lblText = isFav ? "支持率" : "閲覧";

      return `
        <article class="rank-item">
          <div class="rank-row">
            <div>
              <a href="./work.html?key=${key}" aria-label="${esc(title)}">
                <div class="rank-cover">
                  ${img ? `<img src="${esc(img)}" alt="${esc(title)}">` : ``}
                </div>
              </a>
            </div>

            <div class="rank-meta">
              <div class="rank-topline">
                <span class="rank-pos ${posClass(rank)}">${esc(rank)}位</span>
                <span class="rank-metric ${isFav ? "is-fav" : "is-view"}">
                  <span class="num">${esc(numText)}</span>
                  <span class="lbl">${esc(lblText)}</span>
                </span>
              </div>

              <div class="title"><a href="./work.html?key=${key}">${esc(seriesKey || title)}</a></div>
              ${author ? `<div class="sub">${esc(author)}</div>` : ""}
              ${magazine ? `<div class="sub">連載誌: ${esc(magazine)}</div>` : ""}

              ${tagsJa.length ? `<div class="sub">タグ</div>${pillsMax6(tagsJa)}` : ""}
            </div>
          </div>
        </article>
      `;
    }

    // ---- ジャンル絞り込み（stats専用） ----
    const RANK_GENRE_TABS = [
      { id: "all",    label: "すべて", match: [] },
      { id: "action", label: "アクション・バトル", match: ["Action"] },
      { id: "fantasy",label: "ファンタジー・異世界", match: ["Fantasy"] },
      { id: "sf",     label: "SF", match: ["Sci-Fi"] },
      { id: "horror", label: "ホラー", match: ["Horror"] },
      { id: "mystery",label: "ミステリー・サスペンス", match: ["Mystery", "Thriller"] },
      { id: "romance",label: "恋愛・ラブコメ", match: ["Romance"] },
      { id: "slice",  label: "日常", match: ["Slice of Life"] },
      { id: "sports", label: "スポーツ", match: ["Sports"] },
      { id: "drama",  label: "ヒューマンドラマ", match: ["Drama"] },
      { id: "other",  label: "その他", match: ["Adventure", "Psychological", "Supernatural"] },
    ];

    function getRankGenreState() {
      const id = toText(qs().get("rg")) || "all";
      return RANK_GENRE_TABS.some(t => t.id === id) ? id : "all";
    }

    function setRankGenreState(nextId) {
      const p = qs();
      const clean = toText(nextId) || "all";
      if (clean === "all") p.delete("rg");
      else p.set("rg", clean);
      const url = `${location.pathname}?${p.toString()}`;
      history.replaceState(null, "", url);
    }

    function hasAnyGenre(work, wanted) {
      if (!wanted?.length) return true;
      const g = pickArr(work, ["genres", "vol1.genres"]).map(toText).filter(Boolean);
      return wanted.some(x => g.includes(x));
    }

    function renderRankGenreTabs(activeId) {
      const root = document.getElementById("rankGenreTabs");
      if (!root) return;

      root.innerHTML = RANK_GENRE_TABS.map(t => `
        <button
          class="rank-genre ${t.id === activeId ? "is-active" : ""}"
          type="button"
          data-rg="${esc(t.id)}"
          role="tab"
          aria-selected="${t.id === activeId ? "true" : "false"}"
        >
          ${esc(t.label)}
        </button>
      `).join("");

      root.onclick = (ev) => {
        const btn = ev.target?.closest?.("button[data-rg]");
        if (!btn) return;
        const next = btn.getAttribute("data-rg") || "all";
        if (next === getRankGenreState()) return;

        setRankGenreState(next);
        applyGenreAndRerender();
      };
    }

    // ---- 状態 ----
    const MAX_ROWS = 100;
    const STEP = 50;

    let state = {
      tab: "views",
      viewsShown: 0,
      favShown: 0,
      viewsAll: [],
      favAll: [],
      viewsRows: [],
      favRows: [],
      workMap: new Map(),

      // 支持率母数（絞り込み後 favRows の合計）
      favTotal: 0
    };

    function setTab(next) {
      state.tab = next;

      const tViews = document.querySelector(".rank-tab[data-tab='views']");
      const tFav   = document.querySelector(".rank-tab[data-tab='fav']");
      if (tViews) {
        tViews.classList.toggle("is-active", next === "views");
        tViews.setAttribute("aria-selected", next === "views" ? "true" : "false");
      }
      if (tFav) {
        tFav.classList.toggle("is-active", next === "fav");
        tFav.setAttribute("aria-selected", next === "fav" ? "true" : "false");
      }

      const pViews = document.getElementById("panelViews");
      const pFav   = document.getElementById("panelFav");
      if (pViews) pViews.style.display = (next === "views") ? "" : "none";
      if (pFav)   pFav.style.display   = (next === "fav") ? "" : "none";
    }

    function updateMoreButton(kind) {
      if (kind === "views") {
        const btn = document.getElementById("moreViews");
        if (!btn) return;
        const hasMore = state.viewsShown < Math.min(MAX_ROWS, state.viewsRows.length);
        btn.disabled = !hasMore;
        btn.textContent = hasMore ? "もっと見る" : "ここまで";
      }
      if (kind === "fav") {
        const btn = document.getElementById("moreFav");
        if (!btn) return;
        const hasMore = state.favShown < Math.min(MAX_ROWS, state.favRows.length);
        btn.disabled = !hasMore;
        btn.textContent = hasMore ? "もっと見る" : "ここまで";
      }
    }

    function renderMore(kind) {
      if (kind === "views") {
        const root = document.getElementById("rankViews");
        if (!root) return;

        const next = Math.min(MAX_ROWS, state.viewsShown + STEP);
        const chunk = state.viewsRows.slice(state.viewsShown, next);

        const html = chunk.map((r, i) => {
          const seriesKey = toText(r?.seriesKey);
          const n = Number(r?.n || 0);
          const work = state.workMap.get(seriesKey);
          const rank = state.viewsShown + i + 1;
          return (seriesKey && work) ? rankItemHtml({ rank, seriesKey, n, unit: "view", work, favTotal: state.favTotal }) : "";
        }).join("");

        if (state.viewsShown === 0) root.innerHTML = html || `<div class="status">データがまだありません</div>`;
        else root.insertAdjacentHTML("beforeend", html);

        state.viewsShown = next;
        updateMoreButton("views");
      }

      if (kind === "fav") {
        const root = document.getElementById("rankFav");
        if (!root) return;

        const next = Math.min(MAX_ROWS, state.favShown + STEP);
        const chunk = state.favRows.slice(state.favShown, next);

        const html = chunk.map((r, i) => {
          const seriesKey = toText(r?.seriesKey);
          const n = Number(r?.n || 0);
          const work = state.workMap.get(seriesKey);
          const rank = state.favShown + i + 1;
          return (seriesKey && work) ? rankItemHtml({ rank, seriesKey, n, unit: "fav", work, favTotal: state.favTotal }) : "";
        }).join("");

        if (state.favShown === 0) root.innerHTML = html || `<div class="status">データがまだありません</div>`;
        else root.insertAdjacentHTML("beforeend", html);

        state.favShown = next;
        updateMoreButton("fav");
      }
    }

    function applyGenreAndRerender() {
      const activeId = getRankGenreState();
      const tab = RANK_GENRE_TABS.find(t => t.id === activeId) || RANK_GENRE_TABS[0];

      renderRankGenreTabs(tab.id);

      // 絞り込み
      if (!tab.match?.length) {
        state.viewsRows = state.viewsAll.slice();
        state.favRows = state.favAll.slice();
      } else {
        state.viewsRows = state.viewsAll.filter(r => {
          const sk = toText(r?.seriesKey);
          const w = state.workMap.get(sk);
          return w ? hasAnyGenre(w, tab.match) : false;
        });
        state.favRows = state.favAll.filter(r => {
          const sk = toText(r?.seriesKey);
          const w = state.workMap.get(sk);
          return w ? hasAnyGenre(w, tab.match) : false;
        });
      }

      // 支持率母数（絞り込み後 favRows の合計）
      state.favTotal = state.favRows.reduce((acc, r) => acc + Number(r?.n || 0), 0);

      // 描画リセット
      state.viewsShown = 0;
      state.favShown = 0;

      const rv = document.getElementById("rankViews");
      const rf = document.getElementById("rankFav");
      if (rv) rv.innerHTML = "";
      if (rf) rf.innerHTML = "";

      renderMore("views");
      renderMore("fav");

      // タブ状態維持
      setTab(state.tab);
    }

    // ヘッダー：下スクロールで隠す/上で出す
    (function () {
      const header = document.getElementById("gheader");
      if (!header) return;

      let lastY = window.scrollY || 0;
      let ticking = false;

      const SHOW_THRESHOLD = 2;
      const HIDE_THRESHOLD = 8;
      const TOP_KEEP = 12;

      function onScroll() {
        const y = window.scrollY || 0;
        const dy = y - lastY;

        if (y <= TOP_KEEP) { header.classList.remove("is-hidden"); lastY = y; return; }
        if (dy > HIDE_THRESHOLD) { header.classList.add("is-hidden"); lastY = y; return; }
        if (dy < -SHOW_THRESHOLD) { header.classList.remove("is-hidden"); lastY = y; return; }
      }

      window.addEventListener("scroll", () => {
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => { ticking = false; onScroll(); });
      }, { passive: true });
    })();

    async function run() {
      try {
        const v = qs().get("v");
        const bust = !!v;
        const vq = v ? `?v=${encodeURIComponent(v)}` : "";

        const works = await loadJson(`./data/lane2/works.json${vq}`, { bust });
        state.workMap = getWorkMap(works?.items || []);

        const viewBySeries = await loadJson(`./data/metrics/wae/work_view_by_series.json${vq}`, { bust }).catch(() => null);
        const favBySeries  = await loadJson(`./data/metrics/wae/favorite_by_series.json${vq}`, { bust }).catch(() => null);

        state.viewsAll = pickRows(viewBySeries);
        state.favAll   = pickRows(favBySeries);

        // 初期tabは人気
        state.tab = "views";

        // タブ操作
        document.querySelectorAll(".rank-tab[data-tab]").forEach(btn => {
          btn.addEventListener("click", () => {
            const next = btn.getAttribute("data-tab") || "views";
            setTab(next);
          }, { passive: true });
        });

        // もっと見る
        const moreViews = document.getElementById("moreViews");
        if (moreViews) moreViews.addEventListener("click", () => renderMore("views"), { passive: true });

        const moreFav = document.getElementById("moreFav");
        if (moreFav) moreFav.addEventListener("click", () => renderMore("fav"), { passive: true });

        applyGenreAndRerender();
        setStatus("");
      } catch (e) {
        console.error(e);
        setStatus("集計データの読み込みに失敗しました（まだJSONが無い可能性あり）");
      }
    }

    run();
  </script>
</body>
</html>
