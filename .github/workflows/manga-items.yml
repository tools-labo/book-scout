name: Manga items (build)

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *" # JST 12:17 くらい（適当でOK）

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: manga-items
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 1) openBDで書誌/説明を埋める
      - name: Build items from openBD
        run: node scripts/manga/openbd_items.mjs

      # 2) 楽天で1巻を逆引きして items_master に追加
      - name: Backfill vol1 by Rakuten
        run: node scripts/manga/vol1_backfill_rakuten.mjs
        env:
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}

      # 3) 楽天のジャンルID/Nameを raw で付与
      - name: Tag by Rakuten genre (raw)
        run: node scripts/manga/rakuten_tags.mjs
        env:
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}

      # 4) 大ジャンル単位に分割して出力（raw）
      - name: Split works by big genre (raw)
        run: node scripts/manga/split_by_genre.mjs

      # 5) Amazon PA-APIでASIN/URLを埋める
      - name: Install paapi sdk
        run: npm i --no-save paapi5-nodejs-sdk

      - name: Fill Amazon ASIN
        run: node scripts/manga/amazon_asin.mjs
        env:
          AMZ_ACCESS_KEY: ${{ secrets.AMZ_ACCESS_KEY }}
          AMZ_SECRET_KEY: ${{ secrets.AMZ_SECRET_KEY }}
          AMZ_PARTNER_TAG: ${{ secrets.AMZ_PARTNER_TAG }}

      # 6) コミット&プッシュ（差分があるときだけ）
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/manga/items_master.json || true
          git add data/manga/by_genre || true

          if git diff --cached --quiet; then
            echo "no changes"
            exit 0
          fi

          git commit -m "build manga items"
          git push
