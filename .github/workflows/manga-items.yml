name: Manga items (build)

on:
  workflow_dispatch:
  schedule:
    - cron: "15 18 * * *" # JST 03:15

permissions:
  contents: write

concurrency:
  group: manga-items
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build manga data
        env:
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
          AMZ_ACCESS_KEY: ${{ secrets.AMZ_ACCESS_KEY }}
          AMZ_SECRET_KEY: ${{ secrets.AMZ_SECRET_KEY }}
          AMZ_PARTNER_TAG: ${{ secrets.AMZ_PARTNER_TAG }}
          TARGET_ONLY: "1"
          WIKI_MAX: "30"
          DEBUG_KEYS: "1"
        run: |
          set -euo pipefail

          node scripts/manga/openbd_items.mjs

          if [ -n "${RAKUTEN_APP_ID:-}" ]; then
            node scripts/manga/vol1_backfill_rakuten.mjs
            node scripts/manga/rakuten_tags.mjs
            node scripts/manga/rakuten_genre_resolve.mjs
          fi

          node scripts/manga/wikidata_ids.mjs
          node scripts/manga/anilist_tags.mjs
          node scripts/manga/apply_anilist_genres.mjs

          # 重要：series_master を TARGET_ONLY で確実に29件 upsert（スキーマ維持）
          node scripts/manga/anilist_series_master.mjs

          # synopsis 埋め（needsOverride のID/タイトルをログ出し）
          node scripts/manga/fill_series_synopsis.mjs

          node scripts/manga/build_list_items_from_master.mjs
          node scripts/manga/build_indexes.mjs
          node scripts/manga/build_work_pages.mjs

      - name: Commit and push (data/manga only)
        run: |
          set -euo pipefail
          git status --porcelain
          if [ -z "$(git status --porcelain data/manga)" ]; then
            echo "No changes in data/manga"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/manga
          git commit -m "build manga items"
          git push
